<%! from django.utils.translation import ugettext as _ %>
<%namespace name='static' file='/static_content.html'/>


<style>
body {
  font-family:'helvetica neue', 'helvetica';
  font-size:16px;
  background-color: #fbfbf9;
}
.grid-wrapper{
  position: relative;
  float: left;
  clear: both;
  margin:30px 100px 100px 30px;
}

.grid-block{
  position: relative;
  float: left;
  margin: 0 25px 0 0;
}
.grid-block .graph{
  float: left;
  width: 300px;
  margin-left: 50px;
  border-left: 2px solid #444;
  border-bottom: 2px solid #444;
}
.grid-wrapper.radio .graph{
  height: 150px;
}
.grid-wrapper.checkbox .graph{
  height: 250px;
}
.grid-block .graph .y-label{
  position: absolute;
  width: 45px;
  top: -8px;
  left: 0;
  text-align: right;
}
.grid-block .graph .column{
  position: relative;
  height: 100%;
  width: 45px;
  margin: 0 15px;
  float: left;
}
.grid-block .graph .column .block {
  position: absolute;
  width: 100%;
  text-align: center;
}
.grid-block .legend{
  float: left;
  clear: both;
  height: 28px;
  width: 300px;
  margin-left: 50px;
}
.grid-block .legend .label{
  float: left;
  width: 75px;
  padding: 5px 0;
  text-align: center;
}
.grid .view {
}
.answer_box{
  padding:5px 0px;
  background-color:#efefef;
  text-align: center;
}
.wrong{
  background-color:#ffa4a2;
}
.right{
  background-color:#96ec9c;
}
.correct_answer {
  color:#96ec9c;
  background-color: #444;
}
.correct_answer .dot {
  background-color:#efefef;
}

.check{
  content:url('https://class.stanford.edu/static/images/correct-icon.ea93859cc9ff.png');
}
.dot{
  display: inline-block;
  height:20px;
  width: 20px;
  border-radius: 10px;
  background-color: #444;
  margin: 0;
}
.plus{
  font-size:36px;
  font-weight:bold;
  padding-bottom: 5px;
}
.close{
  position:relative;
  top:0;
  left:600px;
}
</style>







${block_content}
<div aria-hidden="true" class="wrap-instructor-info">
  <a class="instructor-info-action instructor-analytics-action" id="${element_id}_analytics_button" data-location="${location}">${_("Staff Analytics Info")}</a>
</div>

<div id="${element_id}_analytics_error_message" style="display: none;">
  <p><strong></strong></p>
</div>

<div id="${element_id}_analytics_close" style="display: none;" class="analytics_close_button" href="#">
  <button class="close">X</button>

% for part_id, correct_response, question_type, has_shuffle in responses_data:
  % if has_shuffle == True:
    <div id="${part_id}_analytics" class="${element_id}_analytics_div" data-has_shuffle="${has_shuffle}">The analytics cannot be displayed as the question uses randomize.
      <p><strong></strong></p>
    </div>
  % elif question_type == 'radio':
    <div id="${part_id}_analytics" class="${element_id}_analytics_div" data-correct_response="${correct_response}" data-question_type="${question_type}" data-has_shuffle="${has_shuffle}">
      <section aria-hidden="true" >
        <div class="grid-wrapper radio">
          <p>Answer distribution of the <strong class="num-students"></strong> students who answered this question.</p>
          <p>Last updated: <strong class="last-update"></strong></p>
          <div class="grid-block table">
            <table cellspacing="2px" id="${part_id}_table">
              <tr>
                <td width="65px">Choice</td>
                <td width="50px"></td>
                <td width="125px" colspan="2">Last Attempt</td>
              </tr>
            </table>
          </div>
        </div>
      </section>
    </div>
  % elif question_type == 'checkbox':
    <div id="${part_id}_analytics" class="${element_id}_analytics_div" data-correct_response="${correct_response}" data-question_type="${question_type}" data-has_shuffle="${has_shuffle}">
      <section aria-hidden="true" >
        <div class="grid-wrapper checkbox">
          <p>Answer distribution of the <strong class="num-students"></strong> students who answered this question:</p>
          <p>Last updated: <strong class="last-update"></strong></p>
          <div class="grid-block table">
            <table cellspacing="2px" id="${part_id}_table">
              <tr class="checkbox_header_row">
                <td width="65px">Choice</td>
              </tr>
            </table>
          </div>
        </div>
      </section>
    </div>
  % endif 
% endfor
</div>

<script src=path></script>

<script type="text/javascript">
//(function () {
    'use strict';

  // Variable for storing if a problem's analytics data has previously been retrieved.
  var elements_retrieved = [];

  // We need to turn off, then on, all click handlers since the click handler gets attached each time the 
  // in-line analytics fragment is added. So, if there are 3 problems on the page, there are three fragments
  // and the same click handler would get called 3 times.
  $('.instructor-analytics-action').off('click.inline-analytics').on('click.inline-analytics', function(event) {
  		
  	
    var element_id = this.id.substring(0, this.id.indexOf('_analytics_button'));
    var location = this.dataset.location;    

    // If data already retrieved for this problem, show the div
	if (elements_retrieved.indexOf(element_id) !== -1) {
	  $('#'+element_id+'_analytics_close').show();
	  return;
	}

    //Hide the error message div
    $('#'+element_id+'_analytics_error_message').hide();
    
    var parts_to_get = [];
    var parts_to_not_get = [];
    var question_types = {}
    var correct_responses = {};
    var index;
    var id, part_id;
    
    var divs = $('.'+element_id+'_analytics_div');
    
    // Construct arrays so we don't call the api for questions with randomize
    var arrayLength = divs.length;
    for (index = 0; index < arrayLength; index++) {
      id = divs[index].id;
      part_id = id.substring(0, id.indexOf('_analytics'))
      if (divs[index].dataset.has_shuffle == "True") {
        parts_to_not_get.push(part_id);
      }else {
    	parts_to_get.push(part_id);
      }
      
      // Build dict of question types
      question_types[part_id] = divs[index].dataset.question_type;
      
      // Build dict of correct responses
      correct_responses[part_id] = divs[index].dataset.correct_response;
    }
    
    if (parts_to_get.length > 0) {
      $.ajax({
        context: this,
        url: "${get_analytics_answer_dist}",
        type: "GET",
        data: {module_id: location},
        dataType: "json",
        
        success: function(response) {
          if (response) {
            process_response(response, parts_to_get, question_types, correct_responses);
            // Store that we retrieved data for this problem
        	elements_retrieved.push(element_id);
            // Show all the graphics
            $('#'+element_id+'_analytics_close').show();
          }
        },
        
        error: function(jqXHR, textStatus, errorThrown) {
          if (jqXHR.status == 404) {
        	$('#'+element_id+'_analytics_error_message').text("The analytics data could not be retrieved, please try again later.").show();
          } else {
        	$('#'+element_id+'_analytics_error_message').text("A problem has occurred retrieving the data, please contact customer support.").show();
        }
      }
    });
    
  } 
});
  
function process_response(response, parts_to_get, question_types, correct_responses) {
	  
  var result = JSON.parse(response.data);
  var last_update_date = response.last_update_date;
  var total_count = 0;
  var total_count_dict = {};
  var part_id;
  var index;

  var data_by_part = {};
  var temp_array = []
  
  for (index in result) {
	if (result.hasOwnProperty(index)) {
	  
	// Calculate the total number of responses for each question
    part_id = result[index]['part_id']
    if (part_id in total_count_dict) {
      total_count_dict[part_id] += result[index]['count'];
    } else {
        total_count_dict[part_id] = result[index]['count'];
    }
    
    // Split result by part_id
    if (part_id in data_by_part) {
    	temp_array = data_by_part[part_id];
    	temp_array.push(result[index]);
    	data_by_part[part_id] = temp_array;
    } else {
    	data_by_part[part_id] = [result[index]];
    }
	}
  }
  
  // Render the appropriate analytics graphics
  var arrayLength = parts_to_get.length;
  for (index = 0; index < arrayLength; index++) {
    part_id = parts_to_get[index];
    
    // May not have any results for this part_id
    if (total_count_dict[part_id]) {
    	total_count = total_count_dict[part_id];
    } else {
    	total_count = 0;
    }
    
    if (question_types[part_id] === 'radio') {
      render_radio_analytics(data_by_part[part_id], part_id, total_count, correct_responses[part_id], last_update_date);
    }else {
      render_checkbox_analytics(data_by_part[part_id], part_id, total_count, correct_responses[part_id], last_update_date);
    }
  }
}


function render_radio_analytics(result, part_id, total_count, correct_response, last_update_date) {
    
    var value_id;
    var current_index;
    var value_index;
    var last_index;
    var correct;
    var count;
    var percent;
    var answer_class;
    var index;
    var tr;
    var trs = [];
    var last_row = $('#'+part_id+'_table tr:last');
    
    // Build the array of choice texts
    var choice_text = get_choice_texts(part_id);
    
    // Loop through results creating rows
    if (result) {
      for (index in result) {
    	if (result.hasOwnProperty(index)) {
        value_id = result[index]['value_id'];
            
        current_index = index;
        value_index = value_id.replace("choice_", "");
            
        // Display rows for gaps in answers in the results
        if (current_index < value_index) {
          insert_missing_rows(part_id, current_index, value_index, correct_response, choice_text, trs);
        }
            
        correct = result[index]['correct'];
        count = result[index]['count'];
        percent = Math.round(count*1000/(total_count*10));
        
        // Display row for the result
        if (correct) {
          answer_class = 'right';
        } else if (!correct) {
          answer_class = 'wrong';
        }  
        tr = $('<tr><td class="answer_box" title="'+choice_text[index]+'">'+(parseInt(index, 10)+1)+'</td><td class="answer_box '+answer_class+'"><span class="dot"></span></td><td class="answer_box">'+count+'</td><td class="answer_box">'+percent+'%</td></tr>');
        trs.push(tr[0]);
      }
      }
      // Display rows for missing answers at the end of results
      last_index = parseInt(result[result.length -1]['value_id'].replace("choice_", ""), 10);
      if (last_index < choice_text.length -1) {
        insert_missing_rows(part_id, last_index + 1, choice_text.length, correct_response, choice_text, trs);  
      }
      
    } else {
      // There were no results
      trs = insert_missing_rows(part_id, 0, choice_text.length, correct_response, choice_text, trs); 
    }
    
    // Append the rows to the table
    last_row.after(trs);
    // Set student count and last_update_date
    set_count_and_date(part_id, total_count, last_update_date);
    
}


function insert_missing_rows(part_id, current_index, final_index, correct_response, choice_text, trs) {

  var answer_class;
  var tr;
  correct_response = correct_response.replace(/(^\[\')|(\'\]$)/g, "");
  
  while (current_index < final_index) {
	if ("choice_"+current_index == correct_response) {
	  answer_class = 'right';
	} else {
	  answer_class = 'wrong';
	}
  	tr = $('<tr><td class="answer_box" title="'+choice_text[current_index]+'">'+(current_index+1)+'</td><td class="answer_box '+answer_class+'"><span class="dot"></span></td><td class="answer_box">0</td><td class="answer_box">0%</td></tr>');
	trs.push(tr[0]);
	current_index += 1;
  }
  return trs;
}


function render_checkbox_analytics(result, part_id, total_count, correct_response, last_update_date) {
	
	 var count;
	 var percent;
	 var answer_class;
	 var actual_response;
	 var imagined_response;
	 var checkbox_checked;
	 var count_row;
	 var index;
	 var max_columns = 10;
	 
	 // Build the array of choice texts
	 var choice_text = get_choice_texts(part_id);
	 
	 var choice_counter = choice_text.length;
	 
	 // Add "Last Attempt" to the choice number column
	 $('#'+part_id+'_table .checkbox_header_row').after('<tr><td id="last_attempt" class="answer_box checkbox_last_attempt">Last Attempt</td></tr>');
	 
	 // Contruct the choice number column
	 while (choice_counter > 0) {
	   $('#'+part_id+'_table .checkbox_header_row').after('<tr><td id="column0:row'+choice_counter+'" class="answer_box" title="'+choice_text[choice_counter-1]+'">'+choice_counter+'</td></tr>');
	   choice_counter -= 1;
	 }
	 
	 // Loop through results creating columns
	 if (result) {
	   // Sort the results in decending response count order
	   result.sort(order_by_count);
	   for (index in result) {
		 if (result.hasOwnProperty(index)) {
		   
	     // Append to the header row
	     $( '<th width="65px"></th>' ).appendTo( $('#'+part_id+'_table tr:eq(0)') );
	   
	     // Append message and break if number of distinct choices >= max_columns
	     if (index >= max_columns) {
	       var not_displayed = result.length - max_columns;
	       $( '<th width="400px"> '+not_displayed+' columns not displayed.</th>' ).appendTo( $('#'+part_id+'_table tr:eq(0)') );
	       break;
	     }
	     actual_response = result[index]['value_id'];
	     choice_counter = 1;
	 
	     while (choice_counter <= choice_text.length) {
	       imagined_response = 'choice_'+(choice_counter -1);
	 
	       // Can't rely in contains method in all browsers so use indexOf
	       if ((correct_response.indexOf(imagined_response) == -1) &&
	           (actual_response.indexOf(imagined_response) == -1) ||
	           (correct_response.indexOf(imagined_response) > -1 &&
	            actual_response.indexOf(imagined_response) > -1)) {
	         answer_class = 'right';
	       }else {
	         answer_class = 'wrong';
	       }
	       if (actual_response.indexOf(imagined_response) != -1) {
	         checkbox_checked = '<span class="dot"></span>';
	       }else {
	         checkbox_checked = '';
	       }
	       $( '<td id="column'+index+':row'+choice_counter+'" class="answer_box '+answer_class+'">'+checkbox_checked+'</td>' ).appendTo( $('#'+part_id+'_table tr:eq('+choice_counter+')') );
	       choice_counter += 1;
	     }

	     // Construct the Last Attempt row
	     count = result[index]['count'];
	     percent = Math.round(count*1000/(total_count*10));
	     count_row += '<td class="answer_box">'+count+'<br/>'+percent+'%</td>'
	   }
	   }
     }
	 // Append count row to the last attempt row
	 $('#'+part_id+'_table #last_attempt' ).after( count_row );
	 
	 // Set student count and last_update_date
	 set_count_and_date(part_id, total_count, last_update_date);
	
}


$('#${element_id}_analytics_close').click(function(event) {
  this.style.display = 'none';
});
	
function get_choice_texts(part_id) {
  var choice_text = [];
  $('#inputtype_'+part_id).find("fieldset label").each(function(index) {
    choice_text[index] = $(this).text();
  });
  return choice_text;
}

function set_count_and_date (part_id, total_count, last_update_date) {
  var part = document.getElementById(part_id+'_analytics');
  part = $(part);
  part.find('.num-students').text(total_count);
  part.find('.last-update').text(last_update_date);
}
	

function order_by_count(a,b) {
  if (a.count > b.count) {
	return -1;
  }
  if (a.count < b.count) {
	return 1;
  }
  return 0;
}

//}());
</script>
    